<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>실시간 카카오맵</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=472f378af49957df6636a87b97fb6fd6&libraries=services"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
    authDomain: "mygps-11798.firebaseapp.com",
    databaseURL: "https://mygps-11798-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mygps-11798",
    storageBucket: "mygps-11798.firebasestorage.app",
    messagingSenderId: "271371741627",
    appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map, marker, addressDiv, distanceDiv;
let destinationMarker, routeLine;
let lastPosition = null;
let routeDrawn = false; // 경로가 이미 그려졌는지 상태

function createMarker(pos) {
    if (marker) marker.setMap(null);

    const containerDiv = document.createElement('div');
    containerDiv.style.position = 'absolute';
    containerDiv.style.width = '30px';
    containerDiv.style.height = '40px';
    containerDiv.style.bottom = '5px';
    containerDiv.style.transform = 'translateX(-50%)';

    const diamondDiv = document.createElement('div');
    diamondDiv.style.width = '30px';
    diamondDiv.style.height = '40px';
    diamondDiv.style.backgroundColor = 'red';
    diamondDiv.style.clipPath = 'polygon(40% 30%, 60% 30%, 85% 45%, 50% 100%, 15% 45%)';

    containerDiv.appendChild(diamondDiv);

    marker = new kakao.maps.CustomOverlay({
        position: pos,
        content: containerDiv,
        yAnchor: 1
    });

    marker.setMap(map);
}

function createDestinationMarker(pos) {
    if (destinationMarker) destinationMarker.setMap(null);

    const containerDiv = document.createElement('div');
    containerDiv.style.position = 'absolute';
    containerDiv.style.width = '30px';
    containerDiv.style.height = '40px';
    containerDiv.style.bottom = '5px';
    containerDiv.style.transform = 'translateX(-50%)';

    const diamondDiv = document.createElement('div');
    diamondDiv.style.width = '30px';
    diamondDiv.style.height = '40px';
    diamondDiv.style.backgroundColor = 'blue';
    diamondDiv.style.clipPath = 'polygon(40% 30%, 60% 30%, 85% 45%, 50% 100%, 15% 45%)';

    containerDiv.appendChild(diamondDiv);

    destinationMarker = new kakao.maps.CustomOverlay({
        position: pos,
        content: containerDiv,
        yAnchor: 1
    });

    destinationMarker.setMap(map);
}

function createAddressDiv(container) {
    if (!addressDiv) {
        addressDiv = document.createElement('div');
        addressDiv.style.position = 'absolute';
        addressDiv.style.top = '0px';
        addressDiv.style.left = '50%';
        addressDiv.style.transform = 'translateX(-50%)';
        addressDiv.style.fontSize = '20px';
        addressDiv.style.fontWeight = '900';
        addressDiv.style.fontFamily = 'sans-serif';
        addressDiv.style.color = '#000';
        addressDiv.style.zIndex = '9999';
        addressDiv.style.whiteSpace = 'nowrap';
        container.appendChild(addressDiv);
    }
}

function createDistanceDiv(container) {
    if (!distanceDiv) {
        distanceDiv = document.createElement('div');
        distanceDiv.style.position = 'absolute';
        distanceDiv.style.bottom = '0px';
        distanceDiv.style.left = '50%';
        distanceDiv.style.transform = 'translateX(-50%)';
        distanceDiv.style.fontSize = '16px';
        distanceDiv.style.fontWeight = 'bold';
        distanceDiv.style.fontFamily = 'sans-serif';
        distanceDiv.style.color = '#0066ff';
        distanceDiv.style.backgroundColor = 'rgba(255,255,255,0.8)';
        distanceDiv.style.padding = '1px 2px';
        distanceDiv.style.borderRadius = '0px';
        distanceDiv.style.zIndex = '9999';
        distanceDiv.style.display = 'block';
        container.appendChild(distanceDiv);
    }
}

const geocoder = new kakao.maps.services.Geocoder();
let currentAddress = {city:'', district:'', neighborhood:''};
function updateAddress(latlng) {
    geocoder.coord2Address(latlng.getLng(), latlng.getLat(), (result, status) => {
        if (status === kakao.maps.services.Status.OK) {
            const region = result[0].address;
            currentAddress.city = region.region_1depth_name || '';
            currentAddress.district = region.region_2depth_name || '';
            currentAddress.neighborhood = region.region_3depth_name || '';
            refreshAddressText();
        } else {
            if (addressDiv) addressDiv.innerText = '주소를 가져올 수 없음';
        }
    });
}

function refreshAddressText() {
    if (!addressDiv) return;
    const container = document.getElementById("map");
    const mapSize = container.offsetWidth;
    let text;
    if (mapSize > 430) text = `${currentAddress.city} ${currentAddress.district} ${currentAddress.neighborhood}`;
    else if (mapSize > 330) text = `${currentAddress.district} ${currentAddress.neighborhood}`;
    else text = `${currentAddress.neighborhood}`;
    addressDiv.innerText = text;
}

function updateDistanceText(data) {
    if (!distanceDiv || !data.routes || data.routes.length === 0) return;
    distanceDiv.style.display = 'block';

    const dist = data.routes[0].summary.distance;
    const distanceText = dist >= 1000 ? (dist/1000).toFixed(2) : dist;
    const unit = dist >= 1000 ? 'km' : 'm';

    distanceDiv.innerHTML = `${distanceText} <span id="distanceUnit">${unit}</span>`;
}

function updateDistanceUnitOnResize() {
    if (!distanceDiv) return;
    const container = document.getElementById("map");
    const mapSize = container.offsetWidth;
    const unitSpan = document.getElementById('distanceUnit');
    if (!unitSpan) return;

    if (mapSize < 200) unitSpan.style.display = 'none';
    else unitSpan.style.display = 'inline';
}

async function fetchRoute(start, end) {
    const REST_KEY = "bac1f5ced0d30c96b782458d968713fe";
    const url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${start.getLng()},${start.getLat()}&destination=${end.getLng()},${end.getLat()}&priority=RECOMMEND`;
    const response = await fetch(url, {
        method: "GET",
        headers: { Authorization: `KakaoAK ${REST_KEY}` }
    });
    const data = await response.json();
    return data;
}

async function drawRealRoute(start, end) {
    if (!start || !end) return;
    if (routeLine) routeLine.setMap(null);
    try {
        const data = await fetchRoute(start, end);
        if (!data.routes || data.routes.length === 0) return;

        updateDistanceText(data);

        const path = [];
        const sections = data.routes[0].sections;
        sections.forEach(sec => {
            sec.roads.forEach(road => {
                for (let i = 0; i < road.vertexes.length; i += 2) {
                    const lng = road.vertexes[i];
                    const lat = road.vertexes[i + 1];
                    path.push(new kakao.maps.LatLng(lat, lng));
                }
            });
        });

        routeLine = new kakao.maps.Polyline({
            map: map,
            path: path,
            strokeWeight: 5,
            strokeColor: '#0066ff',
            strokeOpacity: 0.8,
            strokeStyle: 'solid'
        });
    } catch (e) {
        console.error("경로 가져오기 실패:", e);
    }
}

function getDistance(pos1, pos2) {
    return kakao.maps.LatLng.prototype.distance.call(pos1, pos2);
}

window.onload = function() {
    const container = document.getElementById('map');
    createAddressDiv(container);
    createDistanceDiv(container);

    map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 4
    });

    const locRef = ref(db, "location/current");
    const destRef = ref(db, "location/destination");

    // 내 위치 실시간 갱신
    onValue(locRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        const pos = new kakao.maps.LatLng(data.lat, data.lng);

        if (!marker) createMarker(pos);
        else marker.setPosition(pos);
        map.setCenter(pos);

        if (data.level !== undefined) map.setLevel(data.level);
        if (data.borderRadius !== undefined) container.style.borderRadius = data.borderRadius + 'px';
        if (data.opacity !== undefined) container.style.opacity = data.opacity;
        if (data.mapSize !== undefined) {
            container.style.width = data.mapSize + 'px';
            container.style.height = data.mapSize + 'px';
            map.relayout();
            map.setCenter(pos);
            refreshAddressText();
            updateDistanceUnitOnResize();
        }

        updateAddress(pos);

        if (destinationMarker && !routeDrawn) {
            drawRealRoute(pos, destinationMarker.getPosition());
            routeDrawn = true;
        }
    });

    // 클릭/더블클릭 처리
    let clickTimeout = null;

    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        if (clickTimeout) return;
        clickTimeout = setTimeout(() => {
            clickTimeout = null;
            const clickPos = mouseEvent.latLng;

            if (destinationMarker) {
                set(destRef, null);
                if (distanceDiv) distanceDiv.style.display = 'none';
            } else {
                set(destRef, { lat: clickPos.getLat(), lng: clickPos.getLng() });
            }
        }, 250);
    });

    kakao.maps.event.addListener(map, 'dblclick', function(mouseEvent) {
        if (clickTimeout) {
            clearTimeout(clickTimeout);
            clickTimeout = null;
        }
    });

    // 목적지 실시간 갱신
    onValue(destRef, (snapshot) => {
        const dest = snapshot.val();

        if (!dest) {
            if (destinationMarker) {
                destinationMarker.setMap(null);
                destinationMarker = null;
            }
            if (routeLine) {
                routeLine.setMap(null);
                routeLine = null;
            }
            if (distanceDiv) distanceDiv.style.display = 'none';
            routeDrawn = false;
            return;
        }

        const destPos = new kakao.maps.LatLng(dest.lat, dest.lng);
        if (!destinationMarker) createDestinationMarker(destPos);
        else destinationMarker.setPosition(destPos);

        if (!routeDrawn && marker) {
            drawRealRoute(marker.getPosition(), destPos);
            routeDrawn = true;
        }
    });

    // resize 이벤트
    window.addEventListener('resize', () => {
        refreshAddressText();
        updateDistanceUnitOnResize();
    });
};
</script>
<style>
body {
    margin:0; padding:0; min-height:100vh; position: relative;
}
#map {
    width:200px; height:200px; border:1px solid #000; border-radius:0px;
    transition: border-radius 0.2s ease, opacity 0.2s ease, width 0.2s ease, height 0.2s ease;
    position: absolute; top: 0; right: 0;
}
</style>
</head>
<body>
<div id="map"></div>
</body>
</html>
